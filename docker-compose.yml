version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: teacher-printer-redis
    ports:
      - "6379:6379"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  teacher-printer:
    build: .
    container_name: teacher-printer-web
    ports:
      - "8507:8507"
    volumes:
      - ./printer_inputs:/app/printer_inputs
      - ./printer_outputs:/app/printer_outputs
      - ./printer_processes:/app/printer_processes
    environment:
      - STREAMLIT_SERVER_PORT=8507
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  teacher-printer-worker:
    build: .
    container_name: teacher-printer-worker
    command: rq worker --url redis://redis:6379 default
    volumes:
      - ./printer_inputs:/app/printer_inputs
      - ./printer_outputs:/app/printer_outputs
      - ./printer_processes:/app/printer_processes
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    deploy:
      resources:
        limits:
          memory: 1536M
          cpus: '1.0'
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
